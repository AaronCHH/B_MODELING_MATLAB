%% MATLAB Recipes for Earth Sciences - Chapter 8%% Section 8.3clear%%I1 = imread('unconform.jpg');%%whos%%I1(50:55,50:55,1)%%imshow(I1)%%I2 = rgb2gray(I1);%%whos%%imshow(I2)%%imhist(I2)%%I3 = histeq(I2);%%imshow(I3)%%imwrite(I3,'unconform_gray.jpg')%%imfinfo('unconform_gray.jpg')%%[I4,map] = rgb2ind(I1,16);imshow(I1), figure, imshow(I4,map)%%imwrite(I4,map,'unconform_ind.jpg')%%imshow(I4,map)cmap = colormap%%help graph3d%%imshow(I4,map)colormap(hot)%%rng(0)map = rand(16,3);imshow(I4,map)%%[I5,map] = rgb2ind(I1,3);imshow(I5,[1 0 0;0 1 0;0 0 1])%%imwrite(I5,[1 0 0;0 1 0;0 0 1],'unconform_rgb.jpg')%% Section 8.4clear%%I1 = imread('LC81690572013358LGN00_B4.TIF');I2 = imread('LC81690572013358LGN00_B3.TIF');I3 = imread('LC81690572013358LGN00_B2.TIF');%%whos%%I1 = adapthisteq(I1,'ClipLimit',0.1,'Distribution','Rayleigh');I2 = adapthisteq(I2,'ClipLimit',0.1,'Distribution','Rayleigh');I3 = adapthisteq(I3,'ClipLimit',0.1,'Distribution','Rayleigh');%%I = cat(3,I1,I2,I3);%%axes('XLim',[3000 5000],'YLim',[1000 4000],'Visible','Off'), hold onimshow(I,'InitialMagnification',10)%%imwrite(I(1000:4000,3000:5000,:),'chewbahirbasin.tif','tif')%%clear%%I1 = imread('ethiopianrift_blue.tif');imshow(I1,'InitialMagnification',200), title('Original Image')%%I2 = medfilt2(I1,[10,10],'symmetric');imshow(I2,'InitialMagnification',200), title('Median Filtered Image')%%I3 = imsubtract(I1,I2);imshow(I3,'InitialMagnification',200), title('I1-I2')%%I4 = imsubtract(I2,I1);imshow(I4,'InitialMagnification',200), title('I2-I1')%%I5 = I1;I5(I3>10 | I4>10) = I2(I3>10 | I4>10);imshow(I5,'InitialMagnification',200), title('Despeckled Image')%%subplot(1,2,1)I1S = im2double(I1);surface(I1S), colormap jet, caxis([0 1]), shading interp, view(120,33), axis offaxis([1 size(I1,1) 1 size(I1,2) min(I1S(:)) max(I1S(:))])subplot(1,2,2)I5S = im2double(I5);surface(I5S), colormap jet, caxis([0 1]), shading interp, view(120,33), axis offaxis([1 size(I1,1) 1 size(I1,2) min(I1S(:)) max(I1S(:))])%%subplot(1,2,1), imshow(I1), title('Original Image')subplot(1,2,2), imshow(I5), title('Despeckled Image')%% Section 8.5clear%%filename = 'AST_L1A_003_03082003080706_03242003202838.hdf';%%hdftool(filename)%%I1 = hdfread(filename,'VNIR_Band3N','Fields','ImageData');I2 = hdfread(filename,'VNIR_Band2','Fields','ImageData');I3 = hdfread(filename,'VNIR_Band1','Fields','ImageData');%%I1 = adapthisteq(I1);I2 = adapthisteq(I2);I3 = adapthisteq(I3);%%naivasha_rgb = cat(3,I1,I2,I3);%%imshow(naivasha_rgb)%%imwrite(naivasha_rgb,'naivasha.tif','tif')%%inputpoints(1,:) = [36.214332 -0.319922];  % upper leftinputpoints(2,:) = [36.096003 -0.878267];  % lower leftinputpoints(3,:) = [36.770406 -0.400443];  % upper rightinputpoints(4,:) = [36.652213 -0.958743];  % lower right%%basepoints(1,:) = [1,1];                   % upper leftbasepoints(2,:) = [1,4200];                % lower leftbasepoints(3,:) = [4100,1];                % upper rightbasepoints(4,:) = [4100,4200];             % lower right%%tform = fitgeotrans(inputpoints,basepoints,'affine');%%xLimitsIn = 0.5 + [0 size(naivasha_rgb,2)];yLimitsIn = 0.5 + [0 size(naivasha_rgb,1)];%%[XBounds,YBounds] = outputLimits(tform,xLimitsIn,yLimitsIn);%%Rout = imref2d(size(naivasha_rgb),XBounds,YBounds);%%newnaivasha_rgb = imwarp(naivasha_rgb,tform,'OutputView',Rout);%%X = 36.096003 : (36.770406 - 36.096003)/4100 : 36.770406;Y = -0.958743 : ( 0.958743 -  0.319922)/4200 : -0.319922;%%imshow(newnaivasha_rgb,'XData',X,'YData',Y,'InitialMagnification',10)axis on, grid on, set(gca,'YDir','Normal')xlabel('Longitude'), ylabel('Latitude')title('Georeferenced ASTER Image')%%print -djpeg70 -r600 naivasha_georef.jpg%%clear%%image1 = imread('sugutavalley_1.tif');image2 = imread('sugutavalley_2.tif');%%subplot(1,2,1), imshow(image1)subplot(1,2,2), imshow(image2)%%[optimizer, metric] = imregconfig('monomodal');%%tform = imregtform(image2(:,:,1),image1(:,:,1),'affine',optimizer,metric);%%image2_reg = imwarp(image2,tform,'OutputView',imref2d(size(image1)));%%subplot(1,3,1), imshow(image1)subplot(1,3,2), imshow(image2)subplot(1,3,3), imshowpair(image1,image2_reg,'blend')%%print -djpeg70 -r600 sugutavalley_aligned.jpg%% Section 8.6clear%%HYP = hdfread('EO1H1690582013197110KF.L1R',...    '/EO1H1690582013197110KF.L1R', ...    'Index', {[1 1 1],[1 1 1],[3189 242 256]});%%whos%%HYP = permute(HYP,[1 3 2]);%%HYPR(:,:,1:70) = HYP(:,:,1:70)/40;HYPR(:,:,71:242) = HYP(:,:,71:242)/80;%%fid = fopen('EO1H1690582013197110KF.hdr');C = textscan(fid,'%f %f %f %f %f %f %f %f',...    'Delimiter',',','Headerlines',257,'CollectOutput',1);fclose(fid);%%wavelengths = C{1};wavelengths = wavelengths';wavelengths = wavelengths(isnan(wavelengths(:))==0);%%plot(wavelengths(1:60),squeeze(HYPR(536,136,1:60)),'b',...     wavelengths(71:242),squeeze(HYPR(536,136,71:242)),'r')%%HYP1 = HYPR(:,:,29);HYP2 = HYPR(:,:,23);HYP3 = HYPR(:,:,16);%%subplot(1,3,1), histogram(double(HYP1(:)),100), title('Band 29')subplot(1,3,2), histogram(double(HYP2(:)),100), title('Band 23')subplot(1,3,3), histogram(double(HYP3(:)),100), title('Band 16')%%HYP1 = uint8(HYP1);HYP2 = uint8(HYP2);HYP3 = uint8(HYP3);%%subplot(1,3,1), histogram(single(HYP1(:)),30), title('Band 29')subplot(1,3,2), histogram(single(HYP2(:)),30), title('Band 29')subplot(1,3,3), histogram(single(HYP3(:)),30), title('Band 29')%%subplot(1,3,1), imhist(HYP1(:)), title('Band 29')subplot(1,3,2), imhist(HYP2(:)), title('Band 23')subplot(1,3,3), imhist(HYP3(:)), title('Band 16')%%HYP1 = histeq(HYP1);HYP2 = histeq(HYP2);HYP3 = histeq(HYP3);%%subplot(1,3,1), imhist(HYP1(:)), title('Band 29')subplot(1,3,2), imhist(HYP2(:)), title('Band 23')subplot(1,3,3), imhist(HYP3(:)), title('Band 16')%%HYPC = cat(3,HYP1,HYP2,HYP3);%%imshow(HYPC)%%imshow(HYPC(900:1100,:,:))%%print -r600 -dtiff barrier.tif%% Section 8.7clear%%data = minput('naivasha_georef.jpg')%% Section 8.8clear%%I1 = imread('varves_original.jpg');%%imshow(I1)%%lh = stretchlim(I1)%%I2 = imadjust(I1,lh,[]);%%imshow(I2)%%I3 = imadjust(I1,lh,[],0.5);I4 = imadjust(I1,lh,[],1.5);%%subplot(2,2,1), imshow(I1), title('Original Image')subplot(2,2,2), imshow(I2), title('Adjusted Image, Gamma=1.0')subplot(2,2,3), imshow(I3), title('Adjusted Image, Gamma=0.5')subplot(2,2,4), imshow(I4), title('Adjusted Image, Gamma=1.5')%%subplot(2,2,1), imhist(I1(:,:,1)), title('Original Image')subplot(2,2,2), imhist(I2(:,:,1)), title('Adjusted Image, Gamma=1.0')subplot(2,2,3), imhist(I3(:,:,1)), title('Adjusted Image, Gamma=0.5')subplot(2,2,4), imhist(I4(:,:,1)), title('Adjusted Image, Gamma=1.5')%%I5(:,:,1) = histeq(I1(:,:,1),50);I5(:,:,2) = histeq(I1(:,:,2),50);I5(:,:,3) = histeq(I1(:,:,3),50);%%subplot(2,2,1), imshow(I1), title('Original Image')subplot(2,2,3), imhist(I1(:,:,1)), title('Original Image')subplot(2,2,2), imshow(I5), title('Enhanced Image')subplot(2,2,4), imhist(I5(:,:,1)), title('Enhanced Image')%%I6(:,:,1) = adapthisteq(I1(:,:,1));I6(:,:,2) = adapthisteq(I1(:,:,2));I6(:,:,3) = adapthisteq(I1(:,:,3));%%subplot(2,2,1), imshow(I1), title('Original Image')subplot(2,2,3), imhist(I1(:,:,1)), title('Original Image')subplot(2,2,2), imshow(I6), title('Enhanced Image')subplot(2,2,4), imhist(I6(:,:,1)), title('Enhanced Image')%%h = fspecial('gaussian',20,10);I7 = imfilter(I1,h);%%I8(:,:,1) = medfilt2(I1(:,:,1),[20 20]);I8(:,:,2) = medfilt2(I1(:,:,2),[20 20]);I8(:,:,3) = medfilt2(I1(:,:,3),[20 20]);%%I9 = imsharpen(I1);%%subplot(2,2,1), imshow(I1), title('Original Image')subplot(2,2,2), imshow(I7), title('Gaussian Filter')subplot(2,2,3), imshow(I8), title('Median Filter')subplot(2,2,4), imshow(I9), title('Sharpening Filter')%%imshow(I1)basepoints = ginput%%close allimshow(I1)hold online(basepoints(:,1),basepoints(:,2),...       'LineStyle','none',...       'Marker','+',...       'MarkerSize',48,...       'Color','b')hold off%%dx = (basepoints(3,1)+basepoints(4,1))/2- ...     (basepoints(1,1)+basepoints(2,1))/2dy = (basepoints(2,2)+basepoints(4,2))/2- ...     (basepoints(1,2)+basepoints(3,2))/2%%inputpoints(1,:) = [0 0];inputpoints(2,:) = [0 dy];inputpoints(3,:) = [dx 0];inputpoints(4,:) = [dx dy];%%tform = fitgeotrans(inputpoints,basepoints,'projective');%%xLimitsIn = 0.5 + [0 size(I1,2)]yLimitsIn = 0.5 + [0 size(I1,1)]%%[XBounds,YBounds] = outputLimits(tform,xLimitsIn,yLimitsIn)%%Rout = imref2d(size(I1),XBounds,YBounds)%%I10 = imwarp(I1,tform,'OutputView',Rout);%%subplot(2,1,1), imshow(I1), title('Original Image')subplot(2,1,2), imshow(I10), title('Rectified Image')%%I11 = imcrop(I10);%%subplot(2,1,1), imshow(I1), title('Original Image')subplot(2,1,2), imshow(I11), title('Rectified and Cropped Image')%% Section 8.9clear%%I = imread('varves_original.tif');%%imshow(I), axis on%%[x,y] = ginput;%%ix = 5 * size(I,2) / sqrt((y(2,1)-y(1,1))^2+(x(2,1)-x(1,1))^2);iy = 5 * size(I,1) / sqrt((y(2,1)-y(1,1))^2+(x(2,1)-x(1,1))^2);%%imshow(I,'XData',[0 ix],'YData',[0 iy]), axis onxlabel('Centimeters'), ylabel('Centimeters')%%[CX,CY,C] = improfile;%%imshow(I,'XData',[0 ix],'YData',[0 iy]), hold onplot(CX,CY), hold off%%figureplot(CY,C(:,1),'r',CY,C(:,2),'g',CY,C(:,3),'b')xlabel('Centimeters'), ylabel('Intensity')%%imshow(I,'XData',[0 ix],'YData',[0 iy]), hold onplot(CX,CY), hold offlaminae = ginput;%%imshow(I,'XData',[0 ix],'YData',[0 iy])hold onplot(CX,CY)plot(laminae(:,1),laminae(:,2),'ro')xlabel('Centimeters'), ylabel('Centimeters')hold off%%newlaminae(:,1) = laminae(:,2);newlaminae(:,2) = 1 : length(laminae(:,2));age = interp1(newlaminae(:,1),newlaminae(:,2),CY);%%subplot(2,1,1), plot(CY,C(:,1),CY,C(:,2),CY,C(:,3))xlabel('Centimeters'), ylabel('Intensity'), title('Color vs. Length')subplot(2,1,2), plot(age,C(:,1),age,C(:,2),age,C(:,3))xlabel('Years'), ylabel('Intensity'), title('Color vs. Age')%% Section 8.10clear%%I1 = imread('grainsize.tif');ix = 3; iy = 284 * 3 / 367;imshow(I1,'XData',[0 ix],'YData',[0 iy])title('Original Image')%%I2 = rgb2gray(I1);imshow(I2,'XData',[0 ix],'YData',[0 iy])title('Grayscale Image')%%I3 = imadjust(I2);imshow(I3,'XData',[0 ix],'YData',[0 iy])title('Adjusted Intensity Values')%%I4 = imopen(I3,strel('disk',1));imshow(I4,'XData',[0 ix],'YData',[0 iy])title('No Background')%%I5 = imsubtract(I3,I4);imshow(I5,'XData',[0 ix],'YData',[0 iy])title('Background')%%I6 = im2bw(I4,0.2);imshow(I6,'XData',[0 ix],'YData',[0 iy])title('Binary Image')%%I7 = imclearborder(I6);himage1 = imshow(I6,'XData',[0 ix],'YData',[0 iy]); hold onset(himage1, 'AlphaData', 0.7);himage2 = imshow(imsubtract(I6,I7),'XData',[0 ix],'YData',[0 iy]);set(himage2, 'AlphaData', 0.4);title('Image Border'), hold off%%[B,L] = bwboundaries(I7,'noholes');imshow(label2rgb(L,@jet,'w','shuffle'),'XData',[0 ix],'YData',[0 iy])title('Define Objects')%%[labeled,numObjects] = bwlabeln(I7,8);numObjects%%graindata = regionprops(labeled,'basic');grainareas= [graindata(:).Area];objectareas = 3^2 * grainareas * 367^(-2);%%max_area = max(objectareas)min_area = min(objectareas)mean_area = mean(objectareas)%%clfe = 0 : 0.0005 : 0.15;histogram(objectareas,e)xlabel('Grain Size in Millimeters^2')ylabel('Number of Grains')axis([0 0.1 0 30])%%D = bwdist(~I7,'cityblock');%%D = -D;D(~I7) = -Inf;%%L2 = watershed(D);imshow(label2rgb(L2,@jet,'w','shuffle'),'XData',[0 ix],'YData',[0 iy])title('Watershed Segmentation')%%objects = sortrows(L2(:),1);max(objects)clear objectsizesfor i = 2 : max(objects) clear individualobject individualobject = objects(objects == i); objectsizes(i) = length(individualobject);endobjectsizes = objectsizes';objectsizes = sortrows(objectsizes,1);objectsizes = objectsizes(objectsizes~=0);%%objectareas = 3^2 * objectsizes * 367^(-2);%%max_area = max(objectareas)min_area = min(objectareas)mean_area = mean(objectareas)%%clfe = 0 : 0.0005 : 0.15;histogram(objectareas,e)xlabel('Grain Size in Millimeters^2'),ylabel('Number of Grains')axis([0 0.1 0 70])%%figureimshow(I1,'XData',[0 ix],'YData',[0 iy])data = ginput;%%data(end+1,:) = data(1,:)%%imshow(I1,'XData',[0 ix],'YData',[0 iy]), hold onplot(data(:,1),data(:,2)), hold off%%polyarea(data(:,1),data(:,2))%% Section 8.11clear%%I1 = imread('lakesediment.jpg');ix = 1; iy = 1;imshow(I1,'XData',[0 ix],'YData',[0 iy]), axis onxlabel('Centimeter'), ylabel('Centimeter')title('Original Image')%%I2 = rgb2gray(I1);imshow(I2,'XData',[0 ix],'YData',[0 iy]), axis onxlabel('Centimeters'), ylabel('Centimeters')title('Grayscale')%%I3 = imadjust(I2);imshow(I3,'XData',[0 ix],'YData',[0 iy]), axis onxlabel('Centimeters'), ylabel('Centimeters')title('Better Contrast')%%I4 = imopen(I3,strel('disk',5));imshow(I4,'XData',[0 ix],'YData',[0 iy]), axis onxlabel('Centimeters'), ylabel('Centimeters')title('W/O Background')%%I5 = imsubtract(I3,I4);imshow(I5,'XData',[0 ix],'YData',[0 iy]), axis onxlabel('Centimeters'), ylabel('Centimeters')title('Background')%%I6 = im2bw(I4,0.03);imshow(I6,'XData',[0 ix],'YData',[0 iy]), axis onxlabel('Centimeters'), ylabel('Centimeters')title('Only Charcoal')%%I7 = im2bw(I4,0.6);imshow(I7,'XData',[0 ix],'YData',[0 iy]), axis onxlabel('Centimeters'), ylabel('Centimeters')title('All Objects')%%100*sum(sum(I6==0))/sum(sum(I7==0))%% Section 8.12clear%%I1 = imread('varves_cropped.tif');imshow(I1,'InitialMagnification',30)%%I2 = rgb2gray(I1);imshow(I2,'InitialMagnification',30)%%I3 = adapthisteq(I2,'ClipLimit',0.1,'Distribution','Rayleigh');imshow(I3,'InitialMagnification',30)%%I4 = im2bw(I3, 0.55);imshow(I4,'InitialMagnification',30)%%[H,theta,rho] = hough(I4);%%peaks  = houghpeaks(H,15);%%lines1 = houghlines(I4,theta,rho,peaks(1:5,:));lines2 = houghlines(I4,theta,rho,peaks(6:10,:));lines3 = houghlines(I4,theta,rho,peaks(11:15,:));%%imshow(imadjust(mat2gray(H)),[], ...    'XData',theta, ...    'YData',rho, ...    'InitialMagnification','fit')colormap(hot), axis square, hold onplot(theta(peaks(:,2)),rho(peaks(:,1)), ...    'LineStyle','none', ...    'Marker','s', ...    'Color','b')xlabel('\theta')ylabel('\rho')title('Hough Transform')%%imshow(I1,'InitialMagnification',30), hold onfor k = 1:length(lines1)xy = [lines1(k).point1; lines1(k).point2];plot(xy(:,1),xy(:,2),'LineWidth',3,'Color',[1 0 0]);endhold onfor k = 1:length(lines2)xy = [lines2(k).point1; lines2(k).point2];plot(xy(:,1),xy(:,2),'LineWidth',2,'Color',[1 0 0]);endfor k = 1:length(lines3)xy = [lines3(k).point1; lines3(k).point2];plot(xy(:,1),xy(:,2),'LineWidth',1,'Color',[1 0 0]);end%%clear%%I1 = imread('pollen.jpg');I1 = I1(1:2:end,1:2:end,:);imshow(I1,'InitialMagnification',100)%%I2 = I1(:,:,1);imshow(I2,'InitialMagnification',100)%%I3 = adapthisteq(I2);imshow(I3,'InitialMagnification',100)%%[centers,radii] = imfindcircles(I3,[12 20],...    'Method','TwoStage',...    'ObjectPolarity','Bright',...    'Sensitivity',0.92,...    'EdgeThreshold',0.20);num = length(centers);nstr = ['Number of Pollen Grains: ',num2str(num)];%%imshow(I2,'InitialMagnification',100)viscircles(centers, radii,'EdgeColor','b')title(nstr)%%histogram(radii)